<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, shrink-to-fit=9">
		<meta name="description" content="Gambolthemes">
		<meta name="author" content="Gambolthemes">		
		<title>Fairway Supermarket</title>
		
		<!-- Favicon Icon -->
		<link rel="icon" type="image/png" href="images/fav.png">
		
		<!-- Stylesheets -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<link  href="/user/css/orders.css"  rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
		<link href='/user/vendor/unicons-2.0.1/css/unicons.css' rel='stylesheet'>
		<link href="/user/css/style.css" rel="stylesheet">
		<link href="/user/css/responsive.css" rel="stylesheet">
		<link href="/user/css/night-mode.css" rel="stylesheet">
		<link href="/user/css/customstyle.css" rel="stylesheet">
		<link  href="/user/css/signupmodals.css"  rel="stylesheet">
        <link  href="/user/css/editProfileModal.css"  rel="stylesheet">
		
		<!-- Vendor Stylesheets -->
		<link href="/user/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
		<link href="/user/vendor/OwlCarousel/assets/owl.carousel.css" rel="stylesheet">
		<link href="/user/vendor/OwlCarousel/assets/owl.theme.default.min.css" rel="stylesheet">
		<link href="/user/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="/user/vendor/bootstrap-select/css/bootstrap-select.min.css" rel="stylesheet">	
        
		
		
	</head>


	<body>
		
		
	<!-- Add Address Model End-->
		<%- include('../partials/user/header', { parentCategories: parentCategories }) %>
		<%- include('../partials/user/viewOrderDetailsModal') %>

		
		<!-- Header End -->
	
		<!-- Body Start -->
        <%- include('../partials/user/dashboardOverview') %>
		<div class="col-xl-9 col-lg-8 col-md-12">
			<div class="dashboard-right">
				<div class="row">
					<div class="col-md-12">
						<div class="main-title-tab">
							<h4><i class="uil uil-location-point"></i>My Orders</h4>
						</div>
					</div>
					<div class="col-lg-12 col-md-12">
						<div class="pdpt-bg">
							<div class="col-md-12">
								<div class="order-list-container">
									<% if(orders && orders.length > 0) { %>
										<% orders.forEach(order => { %>
											<div class="order-card">
												<div class="order-header">
													<div class="order-info">
														<span class="order-id">#<%= order._id.toString().slice(-6) %></span>
														<span class="order-date"><%= new Date(order.createdAt).toLocaleDateString() %></span>
													</div>
													<div class="order-status <%= order.orderStatus.toLowerCase() %>">
														<%= order.orderStatus %>
													</div>
												</div>
				
												<div class="order-items">
													<% order.items.forEach(item => { %>
														<div class="order-item">
															<div class="item-image">
																<img src="<%= item.product.images[0] %>" alt="<%= item.product.name %>">
															</div>
															<div class="item-details">
																<h5><%= item.product.name %></h5>
																<p class="item-qty"><%= item.product.quantity + item.product.unit %></p>
																<p class="item-price">
																	<%= item.quantity %> × ₹<%= item.product.discountPrice || item.product.price %>
																</p>
															</div>
														</div>
													<% }); %>
												</div>
												<!-- Add this to your order details modal -->
												<div class="order-status-tracker">
													<div class="status-flow">
														<div class="status-step <%= order.orderStatus === 'Pending' || order.orderStatus === 'Processing' || order.orderStatus === 'Shipped' || order.orderStatus === 'Delivered' ? 'completed' : '' %>">
															<div class="status-icon">
																<i class="uil uil-shopping-cart-alt"></i>
															</div>
															<div class="status-label">Order Placed</div>
															<div class="status-time"><%= new Date(order.createdAt).toLocaleDateString() %></div>
														</div>
												
														<div class="status-step <%= order.orderStatus === 'Processing' || order.orderStatus === 'Shipped' || order.orderStatus === 'Delivered' ? 'completed' : order.orderStatus === 'Cancelled' ? 'cancelled' : '' %>">
															<div class="status-icon">
																<i class="uil uil-process"></i>
															</div>
															<div class="status-label">Processing</div>
															<div class="status-time"><%= order.processingAt ? new Date(order.processingAt).toLocaleDateString() : '--' %></div>
														</div>
												
														<div class="status-step <%= order.orderStatus === 'Shipped' || order.orderStatus === 'Delivered' ? 'completed' : order.orderStatus === 'Cancelled' ? 'cancelled' : '' %>">
															<div class="status-icon">
																<i class="uil uil-truck"></i>
															</div>
															<div class="status-label">Shipped</div>
															<div class="status-time"><%= order.shippedAt ? new Date(order.shippedAt).toLocaleDateString() : '--' %></div>
														</div>
												
														<div class="status-step <%= order.orderStatus === 'Delivered' ? 'completed' : order.orderStatus === 'Cancelled' ? 'cancelled' : '' %>">
															<div class="status-icon">
																<i class="uil uil-check-circle"></i>
															</div>
															<div class="status-label">Delivered</div>
															<div class="status-time"><%= order.deliveredAt ? new Date(order.deliveredAt).toLocaleDateString() : '--' %></div>
														</div>
													</div>
												
													<% if(order.orderStatus === 'Cancelled') { %>
														<div class="cancellation-info">
															<div class="cancel-header">
																<i class="uil uil-times-circle"></i>
																<span>Order Cancelled</span>
															</div>
															<% if(order.cancelReason) { %>
																<div class="cancel-reason">
																	<span>Reason:</span> <%= order.cancelReason %>
																</div>
															<% } %>
														</div>
													<% } %>
												</div>
												
				
												<div class="order-footer">
													<div class="order-total">
														<span>Total:</span>
														<span class="total-amount">₹<%= order.discountTotal.toFixed(2) %></span>
													</div>
													<div class="order-actions">
														<button class="view-details-btn" onclick="viewOrderDetails('<%= order._id %>')">
															View Details
														</button>
														<% if(order.orderStatus === 'Pending' || order.orderStatus === 'Processing') { %>
															<button class="cancel-order-btn" onclick="cancelOrder('<%= order._id %>')">
																Cancel Order
															</button>
														<% } %>
													</div>
												</div>
											</div>
											
										<% }); %>
									<% } else { %>
										<div class="no-orders">
											<div class="no-orders-content">
												<i class="uil uil-box"></i>
												<h3>No Orders Yet</h3>
												<p>Looks like you haven't made your first order yet.</p>
												<a href="/" class="start-shopping-btn">Start Shopping</a>
											</div>
										</div>
									<% } %>
								</div>
							</div>
						</div>
					</div>
				</div>
     
        
        <%- include('../partials/user/resetResetModal') %>

        


	<!-- Javascripts -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="/user/js/jquery.min.js"></script>
	<script src="/user/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="/user/vendor/bootstrap-select/js/bootstrap-select.min.js"></script>	
	<script src="/user/vendor/OwlCarousel/owl.carousel.js"></script>
	<script src="/user/js/jquery.countdown.min.js"></script>
	<script src="/user/js/custom.js"></script>
	<script src="/user/js/offset_overlay.js"></script>
	<script src="/user/js/night-mode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="/user/js/editReset.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
	<script >
		async function viewOrderDetails(orderId) {
    try {
        const response = await fetch(`/orders/${orderId}`);
        const data = await response.json();

        if (data.success) {
            // Get the modal content container
            const modalContent = document.getElementById('orderDetailsContent');
            const order = data.order;

            // Update the modal content with order details
            modalContent.innerHTML = `
                <div class="order-detail-content">
                    <!-- Order Information Section -->
                    <div class="detail-section">
                        <h6>Order Information</h6>
                        <div class="detail-info">
                            <p><strong>Order ID:</strong> #${order._id.toString().slice(-6)}</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span class="status ${order.orderStatus.toLowerCase()}">${order.orderStatus}</span></p>
                            <p><strong>Payment Method:</strong> ${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment'}</p>
                        </div>
                    </div>

                    <!-- Delivery Address Section -->
                    <div class="detail-section">
                        <h6>Delivery Address</h6>
                        <div class="detail-info">
                            <p><strong>${order.deliveryAddress.name}</strong></p>
                            <p>${order.deliveryAddress.mobile}</p>
                            <p>${order.deliveryAddress.flat}, ${order.deliveryAddress.addressLine}</p>
                            <p>${order.deliveryAddress.city}, ${order.deliveryAddress.state} - ${order.deliveryAddress.pincode}</p>
                        </div>
                    </div>

                    <!-- Order Items Section -->
                    <div class="detail-section">
                        <h6>Order Items</h6>
                        <div class="detail-items">
                            ${order.items.map(item => `
                                <div class="detail-item">
                                    <img src="${item.product.images[0]}" alt="${item.product.name}">
                                    <div class="item-info">
                                        <h6>${item.product.name}</h6>
                                        <p>${item.quantity} × ₹${item.product.discountPrice || item.product.price}</p>
                                    </div>
                                    <div class="item-total">
                                        ₹${((item.product.discountPrice || item.product.price) * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Price Details Section -->
                    <div class="detail-section">
                        <h6>Price Details</h6>
                        <div class="price-breakdown">
                            <div class="price-row">
                                <span>Subtotal</span>
                                <span>₹${order.total.toFixed(2)}</span>
                            </div>
                            ${order.total - order.discountTotal > 0 ? `
                                <div class="price-row discount">
                                    <span>Discount</span>
                                    <span>-₹${(order.total - order.discountTotal).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="price-row">
                                <span>Delivery</span>
                                <span class="free">FREE</span>
                            </div>
                            <div class="price-row total">
                                <span>Total Amount</span>
                                <span>₹${order.discountTotal.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Show the modal
            const orderModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            orderModal.show();
        } else {
            throw new Error(data.message || 'Failed to load order details');
        }
    } catch (error) {
        console.error('View order details error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load order details'
        });
    }
}
async function cancelOrder(orderId) {
    try {
        const result = await Swal.fire({
            title: 'Cancel Order?',
            text: "Are you sure you want to cancel this order?",
            icon: 'warning',
            input: 'textarea',
            inputLabel: 'Reason for cancellation',
            inputPlaceholder: 'Please provide a reason...',
            inputAttributes: {
                'aria-label': 'Reason for cancellation'
            },
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, cancel it',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please enter a reason for cancellation';
                }
            }
        });

        if (result.isConfirmed) {
            const response = await fetch('/orders/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderId,
                    reason: result.value
                })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Order Cancelled',
                    text: 'Your order has been cancelled successfully',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(data.message);
            }
        }
    } catch (error) {
        console.error('Cancel order error:', error);
        showErrorNotification(error.message || 'Failed to cancel order');
    }
}

// Show notifications
function showErrorNotification(message) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000
    });
}


	</script>

</body>
</html>