<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description-gambolthemes" content="">
	<meta name="author-gambolthemes" content="">
	<title>Gambo Supermarket Admin</title>
	<link href="css/styles.css" rel="stylesheet">
	<link href="css/admin-style.css" rel="stylesheet">
	<link rel="stylesheet" href="css/admin-custom.css">
	
	<!-- Vendor Stylesheets -->
	<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
	
</head>

    <body class="sb-nav-fixed">
		<%- include('../partials/admin/topnav') %>
     
        <div id="layoutSidenav">
			<%- include('../partials/admin/sidebar') %>
            <div id="layoutSidenav_content">
                <main>
					<div class="container-fluid">
						<h2 class="mt-30 page-title">Categories</h2>
						<ol class="breadcrumb mb-30">
							<li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
							<li class="breadcrumb-item active">Categories</li>
						</ol>
					
						<div class="row justify-content-between">
							<div class="col-lg-12">
								<a href="/admin/categories/add" class="add-btn hover-btn">Add New</a>
							</div>
							
							<!-- Filters Section -->
							<div class="col-lg-12 col-md-12">
								<form action="/admin/categories" method="GET" class="row">
									<div class="col-lg-3 col-md-4">
										<div class="bulk-section mt-30">
											<div class="input-group">
												<select id="listed" name="listed" class="form-control">
													<option value="">All Status</option>
													<option value="true" <%= filters.listed === 'true' ? 'selected' : '' %>>Listed</option>
													<option value="false" <%= filters.listed === 'false' ? 'selected' : '' %>>Unlisted</option>
												</select>
											</div>
										</div>
									</div>
									<div class="col-lg-6 col-md-5">
										<div class="bulk-section mt-30">
											<div class="search-by-name-input">
												<input type="text" name="search" class="form-control" placeholder="Search by name" value="<%= filters.search %>">
											</div>
											<div class="input-group">
												<select id="parent" name="parent" class="form-control">
													<option value="">All Categories</option>
													<% parentCategories.forEach(category => { %>
														<option value="<%= category._id %>" <%= filters.parent === category._id.toString() ? 'selected' : '' %>>
															<%= category.name %>
														</option>
													<% }) %>
												</select>
												<div class="input-group-append">
													<button class="status-btn hover-btn" type="submit">Search</button>
												</div>
											</div>
										</div>
									</div>
								</form>
							</div>
					
							<!-- Categories Table -->
							<div class="col-lg-12 col-md-12">
								<div class="card card-static-2 mt-30 mb-30">
									<div class="card-title-2">
										<h4>All Categories</h4>
									</div>
									<div class="card-body-table">
										<div class="table-responsive">
											<table class="table ucp-table table-hover">
												<thead>
													<tr>
														<th style="width:130px">Image</th>
														<th>Name</th>
														<th>Parent Category</th>
														<th>Discount %</th>
														<th>Status</th>
														<th>Action</th>
													</tr>
												</thead>
												<tbody>
													<% if (categories.length === 0) { %>
														<tr>
															<td colspan="6" class="text-center">No categories found</td>
														</tr>
													<% } %>
													
													<% categories.forEach(category => { %>
													<tr id="category-row-<%= category._id %>">
														<td>
															<div class="cate-img">
																<% if (category.image) { %>
																	<img src="<%= category.image %>" alt="<%= category.name %>">
																<% } else { %>
																	<img src="/admin/images/category/icon-1.svg" alt="default">
																<% } %>
															</div>
														</td>
														<td><%= category.name %></td>
														<td><%= category.parent ? category.parent.name : 'None' %></td>
														<td><%= category.discount || 0 %>%</td>
														<td>
															<label class="toggle-switch success" title="<%= category.listed ? 'Active' : 'Inactive' %>">
																<input type="checkbox" 
																	   onchange="toggleCategoryStatus('<%= category._id %>', this.checked)"
																	   <%= category.listed ? 'checked' : '' %>>
																<span class="toggle-slider"></span>
															</label>
														</td>
														
														<td class="action-btns">
															<button class="edit-btn" 
																	id="toggle-btn-<%= category._id %>"
																	onclick="toggleCategoryStatus('<%= category._id %>', <%= category.listed %>)">
																<i class="fas fa-sync-alt"></i>
																<%= category.listed ? 'Unlist' : 'List' %>
															</button>
															<a href="/admin/categories/edit/<%= category._id %>" class="edit-btn">
																<i class="fas fa-edit"></i> Edit
															</a>
															<button class="edit-btn text-danger" 
																	onclick="deleteCategory('<%= category._id %>')">
																<i class="fas fa-trash"></i> Delete
															</button>
														</td>
													</tr>
														
														
													<% }) %>
												</tbody>
											</table>
										</div>
					
										<!-- Pagination -->
										<% if (pagination.totalPages > 1) { %>
											<nav aria-label="Page navigation" class="mt-4">
												<ul class="pagination justify-content-center">
													<li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
														<a class="page-link" href="?page=<%= pagination.page - 1 %>&search=<%= filters.search %>&parent=<%= filters.parent %>&listed=<%= filters.listed %>">
															Previous
														</a>
													</li>
													
													<% for(let i = 1; i <= pagination.totalPages; i++) { %>
														<li class="page-item <%= pagination.page === i ? 'active' : '' %>">
															<a class="page-link" href="?page=<%= i %>&search=<%= filters.search %>&parent=<%= filters.parent %>&listed=<%= filters.listed %>">
																<%= i %>
															</a>
														</li>
													<% } %>
													
													<li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
														<a class="page-link" href="?page=<%= pagination.page + 1 %>&search=<%= filters.search %>&parent=<%= filters.parent %>&listed=<%= filters.listed %>">
															Next
														</a>
													</li>
												</ul>
											</nav>
										<% } %>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<!-- Add this script at the bottom of your page -->
					<script>
					async function toggleCategoryStatus(categoryId, newStatus) {
						try {
							const response = await fetch(`/admin/categories/listing/${categoryId}`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({ listed: newStatus })
							});
					
							const data = await response.json();
					
							if (data.success) {
								// Show a subtle success notification
								Swal.fire({
									icon: 'success',
									title: data.message,
									toast: true,
									position: 'top-end',
									showConfirmButton: false,
									timer: 3000,
									timerProgressBar: true,
									didOpen: (toast) => {
										toast.addEventListener('mouseenter', Swal.stopTimer)
										toast.addEventListener('mouseleave', Swal.resumeTimer)
									}
								});
					
								// Find the toggle and update its state if needed
								const toggleInput = document.querySelector(`#category-${categoryId} input[type="checkbox"]`);
								if (toggleInput) {
									toggleInput.checked = newStatus;
								}
							} else {
								// Revert the toggle if there was an error
								const toggleInput = document.querySelector(`#category-${categoryId} input[type="checkbox"]`);
								if (toggleInput) {
									toggleInput.checked = !newStatus;
								}
					
								// Show error message
								Swal.fire({
									icon: 'error',
									title: 'Error',
									text: data.message
								});
							}
						} catch (error) {
							console.error('Error:', error);
							// Revert the toggle on error
							const toggleInput = document.querySelector(`#category-${categoryId} input[type="checkbox"]`);
							if (toggleInput) {
								toggleInput.checked = !newStatus;
							}
					
							Swal.fire({
								icon: 'error',
								title: 'Error',
								text: 'Something went wrong'
							});
						}
					}
					
					
					async function deleteCategory(categoryId) {
    					try {
        					const result = await Swal.fire({
           					 title: 'Are you sure?',
           					 text: "You won't be able to revert this!",
           					 icon: 'warning',
           					 showCancelButton: true,
           					 confirmButtonColor: '#3085d6',
            				cancelButtonColor: '#d33',
            				confirmButtonText: 'Yes, delete it!'
        					});

        					if (result.isConfirmed) {
            				const response = await fetch(`/admin/categories/delete${categoryId}`, {
               			 	method: 'DELETE',
                			headers: {
                    		'Content-Type': 'application/json'
                			}
            				});

            				const data = await response.json();

            				if (data.success) {
                			// Remove the row from the table without reloading
                			const row = document.querySelector(`#category-row-${categoryId}`);
                			if (row) {
                    		row.remove();
                		}

                		// Show success message
                		Swal.fire({
                   		 icon: 'success',
                    	title: 'Deleted!',
                    	text: data.message,
                    	showConfirmButton: false,
                   		 timer: 1500
               			 });
            			} else {
                		Swal.fire({
                    	icon: 'error',
                    	title: 'Error',
                    	text: data.message
                		});
            			}
       					 }
    					} catch (error) {
        				console.error('Error:', error);
       				 Swal.fire({
            			icon: 'error',
            			title: 'Error',
            			text: 'Something went wrong'
        				});
    					}
						}
					
					
					
					
					</script>


                </main>
                <%- include('../partials/admin/footer') %>
            </div>
        </div>
        <script src="js/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="js/scripts.js"></script>
       
    </body>
</html>
