<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description-gambolthemes" content="">
		<meta name="author-gambolthemes" content="">
		<title>Fairway Supermarket Admin</title>
		<link href="css/styles.css" rel="stylesheet">
		<link href="css/admin-style.css" rel="stylesheet">
		<link href="css/admin-custom" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<link  href="/admin/css/inventory.css"  rel="stylesheet">
		<style>
			
			</style>
		
		<!-- Vendor Stylesheets -->
		<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
		
	</head>

    <body class="sb-nav-fixed">
		<%- include('../partials/admin/topnav') %>
        <div id="layoutSidenav">
			<%- include('../partials/admin/sidebar') %>
            <div id="layoutSidenav_content">
                <main>
					<div class="container-fluid">
						<h2 class="mt-30 page-title">Orders</h2>
						<ol class="breadcrumb mb-30">
							<li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
							<li class="breadcrumb-item active">Inventory</li>
						</ol>
					
						<div class="container-fluid">
                            <!-- Header -->
                            <div class="inventory-header">
                                <div class="header-content">
                                    <div class="header-left">
                                        <h2><i class="fas fa-boxes"></i> Inventory Management</h2>
                                        <div class="stats-cards">
                                            <div class="stat-card">
                                                <div class="stat-icon low">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <h4><%= lowStockCount %></h4>
                                                    <span>Low Stock Items</span>
                                                </div>
                                            </div>
                                            <div class="stat-card">
                                                <div class="stat-icon total">
                                                    <i class="fas fa-cube"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <h4><%= totalProducts %></h4>
                                                    <span>Total Products</span>
                                                </div>
                                            </div>
                                            <div class="stat-card">
                                                <div class="stat-icon out">
                                                    <i class="fas fa-times-circle"></i>
                                                </div>
                                                <div class="stat-info">
                                                    <h4><%= outOfStockCount %></h4>
                                                    <span>Out of Stock</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="header-actions">
                                        <button class="btn custom-btn" onclick="updateBulkStock()">
                                            <i class="fas fa-sync-alt"></i> Bulk Update
                                        </button>
                                        <button class="btn custom-btn" onclick="downloadInventoryReport()">
                                            <i class="fas fa-download"></i> Export Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Main Content -->
                            <div class="inventory-content">
                                <!-- Filters -->
                                <div class="filters-section">
                                    <div class="search-box">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="searchInventory" placeholder="Search products...">
                                    </div>
                                    <div class="filter-group">
                                        <select id="categoryFilter">
                                            <option value="">All Categories</option>
                                            <% categories.forEach(category => { %>
                                                <option value="<%= category.name %>"><%= category.name %></option>
                                            <% }); %>
                                        </select>
                                        <select id="stockFilter">
                                            <option value="">All Stock Status</option>
                                            <option value="in">In Stock</option>
                                            <option value="low">Low Stock</option>
                                            <option value="out">Out of Stock</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Count Display -->
                                <div class="count-display">
                                    <span class="visible-count">Showing <%= products.length %> items</span>
                                </div>
                        
                                <!-- Inventory Table -->
                                <div class="inventory-table-container">
                                    <table class="inventory-table">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" id="selectAll">
                                                </th>
                                                <th>Product</th>
                                                <th>Category</th>
                                                <th>SKU</th>
                                                <th>Stock</th>
                                                <th>Status</th>
                                                <th>Last Updated</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% products.forEach(product => { %>
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" class="product-select" value="<%= product._id %>">
                                                    </td>
                                                    <td>
                                                        <div class="product-cell">
                                                            <img src="<%= product.images[0] %>" alt="<%= product.name %>">
                                                            <div class="product-info">
                                                                <h6><%= product.name %></h6>
                                                                <span><%= product.quantity + product.unit %></span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td><%= product.category.name %></td>
                                                    <td><%= product.sku || '-' %></td>
                                                    <td>
                                                        <div class="stock-cell">
                                                            <span class="stock-value <%= getStockClass(product.stock) %>">
                                                                <%= product.stock %>
                                                            </span>
                                                            <button class="update-stock-btn" onclick="openStockModal('<%= product._id %>')">
                                                                <i class="fas fa-pen"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="status-badge <%= getStockStatusClass(product.stock) %>">
                                                            <%= getStockStatus(product.stock) %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <%= new Date(product.updatedAt).toLocaleDateString() %>
                                                    </td>
                                                    <td>
                                                        <div class="action-buttons">
                                                            <button class="btn-icon view" onclick="viewStockHistory('<%= product._id %>')" 
                                                                    title="View History">
                                                                <i class="fas fa-history"></i>
                                                            </button>
                                                            <button class="btn-icon alert" onclick="setStockAlert('<%= product._id %>')"
                                                                    title="Set Alert">
                                                                <i class="fas fa-bell"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Stock Update Modal -->
<div class="modal fade" id="stockUpdateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="update-form">
                    <input type="hidden" id="updateProductId">
                    <div class="form-group">
                        <label>Current Stock</label>
                        <input type="number" id="currentStock" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label>Update Type</label>
                        <select id="updateType" class="form-select">
                            <option value="add">Add Stock</option>
                            <option value="remove">Remove Stock</option>
                            <option value="set">Set Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="updateQuantity" class="form-control" min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="updateNotes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStock()">Update</button>
            </div>
        </div>
    </div>
</div>
          </main>
            </div>
        </div>
        <script src="js/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="js/scripts.js"></script>   
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
        });
        
        function initializeFilters() {
            const searchInput = document.getElementById('searchInventory');
            const categoryFilter = document.getElementById('categoryFilter');
            const stockFilter = document.getElementById('stockFilter');
        
            // Add event listeners
            searchInput.addEventListener('input', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
            stockFilter.addEventListener('change', applyFilters);
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const categoryValue = document.getElementById('categoryFilter').value;
            const stockValue = document.getElementById('stockFilter').value;
        
            // Get all product rows
            const rows = document.querySelectorAll('.inventory-table tbody tr');
        
            rows.forEach(row => {
                let showRow = true;
        
                // Search filter
                const productName = row.querySelector('.product-info h6').textContent.toLowerCase();
                if (searchTerm && !productName.includes(searchTerm)) {
                    showRow = false;
                }
        
                // Category filter
                if (categoryValue) {
                    const category = row.cells[2].textContent; // Adjust index based on your table structure
                    if (category !== categoryValue) {
                        showRow = false;
                    }
                }
        
                // Stock filter
                if (stockValue) {
                    const stockStatus = row.querySelector('.status-badge').textContent.trim();
                    const matchesStock = matchesStockFilter(stockStatus, stockValue);
                    if (!matchesStock) {
                        showRow = false;
                    }
                }
        
                // Show/hide row
                row.style.display = showRow ? '' : 'none';
            });
        
            // Update visible items count
            updateVisibleCount();
        }
        
        function matchesStockFilter(status, filterValue) {
            switch(filterValue) {
                case 'low':
                    return status === 'Low Stock';
                case 'out':
                    return status === 'Out of Stock';
                case 'in':
                    return status === 'In Stock';
                default:
                    return true;
            }
        }
        
        function updateVisibleCount() {
            const visibleRows = document.querySelectorAll('.inventory-table tbody tr:not([style*="display: none"])');
            const countDisplay = document.querySelector('.visible-count');
            if (countDisplay) {
                countDisplay.textContent = `Showing ${visibleRows.length} items`;
            }
        }
        
        // Helper function to debounce search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Apply debouncing to search
        const searchInput = document.getElementById('searchInventory');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(() => {
                applyFilters();
            }, 300));
        }</script>
    </body>
</html>
