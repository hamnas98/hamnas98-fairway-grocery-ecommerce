<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description-gambolthemes" content="">
		<meta name="author-gambolthemes" content="">
		<title>Fairway Supermarket Admin</title>
		<link href="css/styles.css" rel="stylesheet">
		<link href="css/admin-style.css" rel="stylesheet">
		<link href="css/admin-custom" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<link  href="/admin/css/offers.css"  rel="stylesheet">
		<style>
			
			</style>
		
		<!-- Vendor Stylesheets -->
		<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
		
	</head>

    <body class="sb-nav-fixed">
		<%- include('../partials/admin/topnav') %>
        <div id="layoutSidenav">
			<%- include('../partials/admin/sidebar') %>
            <div id="layoutSidenav_content">
                <main>
					<div class="container-fluid">
						<h2 class="mt-30 page-title">Orders</h2>
						<ol class="breadcrumb mb-30">
							<li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
							<li class="breadcrumb-item active">Orders</li>
						</ol>
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-12">
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="tab" href="#product-offers">Product Offers</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#category-offers">Category Offers</a>
                                        </li>
                                    </ul>
                        
                                    <!-- Tab content -->
                                    <div class="tab-content">
                                        <!-- Product Offers -->
                                        <div id="product-offers" class="tab-pane active">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h4>Product Offers</h4>
                                                <button class="btn btn-primary" onclick="showProductOfferModal()">
                                                    <i class="fas fa-plus"></i> Create Offer
                                                </button>
                                            </div>
                        
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Discount</th>
                                                            <th>Valid From</th>
                                                            <th>Valid Until</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% productOffers.forEach(offer => { %>
                                                            <tr>
                                                                <td><%= offer.product.name %></td>
                                                                <td>
                                                                    <%= offer.discountType === 'percentage' ? 
                                                                        `${offer.discountAmount}%` : 
                                                                        `₹${offer.discountAmount}` %>
                                                                </td>
                                                                <td><%= new Date(offer.startDate).toLocaleDateString() %></td>
                                                                <td><%= new Date(offer.endDate).toLocaleDateString() %></td>
                                                                <td>
                                                                    <span class="badge <%= new Date() > new Date(offer.endDate) ? 'bg-danger' : 'bg-success' %>">
                                                                        <%= new Date() > new Date(offer.endDate) ? 'Expired' : 'Active' %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-danger" onclick="deleteOffer('<%= offer._id %>', 'product')">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                        
                                        <!-- Category Offers -->
                                        <div id="category-offers" class="tab-pane fade">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h4>Category Offers</h4>
                                                <button class="btn btn-primary" onclick="showCategoryOfferModal()">
                                                    <i class="fas fa-plus"></i> Create Offer
                                                </button>
                                            </div>
                        
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Category</th>
                                                            <th>Discount</th>
                                                            <th>Valid From</th>
                                                            <th>Valid Until</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% categoryOffers.forEach(offer => { %>
                                                            <tr>
                                                                <td><%= offer.category.name %></td>
                                                                <td>
                                                                    <%= offer.discountType === 'percentage' ? 
                                                                        `${offer.discountAmount}%` : 
                                                                        `₹${offer.discountAmount}` %>
                                                                </td>
                                                                <td><%= new Date(offer.startDate).toLocaleDateString() %></td>
                                                                <td><%= new Date(offer.endDate).toLocaleDateString() %></td>
                                                                <td>
                                                                    <span class="badge <%= new Date() > new Date(offer.endDate) ? 'bg-danger' : 'bg-success' %>">
                                                                        <%= new Date() > new Date(offer.endDate) ? 'Expired' : 'Active' %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-danger" onclick="deleteOffer('<%= offer._id %>', 'category')">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- product offer modal -->
                        <div class="modal fade" id="productOfferModal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5>Create Product Offer</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="productOfferForm">
                                            <div class="mb-3">
                                                <label>Product</label>
                                                <select class="form-select" name="productId" required>
                                                    <option value="">Select Product</option>
                                                    <% products.forEach(product => { %>
                                                        <option value="<%= product._id %>"><%= product.name %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label>Discount Type</label>
                                                        <select class="form-select" name="discountType" required>
                                                            <option value="percentage">Percentage</option>
                                                            <option value="fixed">Fixed Amount</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label>Discount Amount</label>
                                                        <input type="number" class="form-control" name="discountAmount" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label>Start Date</label>
                                                        <input type="date" class="form-control" name="startDate" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label>End Date</label>
                                                        <input type="date" class="form-control" name="endDate" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="createProductOffer()">Create Offer</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Create Category Offer Modal -->
                        <div class="modal fade" id="categoryOfferModal">
                           <div class="modal-dialog">
                               <div class="modal-content">
                                   <div class="modal-header">
                                       <h5>Create Category Offer</h5>
                                       <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                   </div>
                                   <div class="modal-body">
                                       <form id="categoryOfferForm">
                                           <div class="mb-3">
                                               <label>Category</label>
                                               <select class="form-select" name="categoryId" required>
                                                   <option value="">Select Category</option>
                                                   <% categories.forEach(category => { %>
                                                       <option value="<%= category._id %>"><%= category.name %></option>
                                                   <% }); %>
                                               </select>
                                           </div>
                                           <div class="row">
                                               <div class="col-md-6">
                                                   <div class="mb-3">
                                                       <label>Discount Type</label>
                                                       <select class="form-select" name="discountType" required>
                                                           <option value="percentage">Percentage</option>
                                                           <option value="fixed">Fixed Amount</option>
                                                       </select>
                                                   </div>
                                               </div>
                                               <div class="col-md-6">
                                                   <div class="mb-3">
                                                       <label>Discount Amount</label>
                                                       <input type="number" class="form-control" name="discountAmount" min="0" required>
                                                       <small class="text-muted discount-hint"></small>
                                                   </div>
                                               </div>
                                           </div>
                                           <div class="row">
                                               <div class="col-md-6">
                                                   <div class="mb-3">
                                                       <label>Start Date</label>
                                                       <input type="date" class="form-control" name="startDate" min="<%= new Date().toISOString().split('T')[0] %>" required>
                                                   </div>
                                               </div>
                                               <div class="col-md-6">
                                                   <div class="mb-3">
                                                       <label>End Date</label>
                                                       <input type="date" class="form-control" name="endDate" min="<%= new Date().toISOString().split('T')[0] %>" required>
                                                   </div>
                                               </div>
                                           </div>
                                           <div class="alert alert-info">
                                               <i class="fas fa-info-circle"></i>
                                               This offer will apply to all products in the selected category
                                           </div>
                                       </form>
                                   </div>
                                   <div class="modal-footer">
                                       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                       <button type="button" class="btn btn-primary" onclick="createCategoryOffer()">Create Offer</button>
                                   </div>
                               </div>
                           </div>
                        </div>
                        
					</div>
                </main>
            </div>
        </div>
        <script src="js/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="js/scripts.js"></script>   
        <script>function showProductOfferModal() {
            document.getElementById('productOfferForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('productOfferModal'));
            modal.show();
         }
         
         function showCategoryOfferModal() {
            document.getElementById('categoryOfferForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('categoryOfferModal'));
            modal.show();
         }
         
         async function createProductOffer() {
            const form = document.getElementById('productOfferForm');
            const formData = new FormData(form);
            const formValues = Object.fromEntries(formData);
         
            if (!validateOfferForm(formValues)) return;
         
            try {
                const response = await fetch('/admin/offers/product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formValues)
                });
         
                const data = await response.json();
         
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => window.location.reload());
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to create offer'
                });
            }
         }
         
         async function createCategoryOffer() {
            const form = document.getElementById('categoryOfferForm');
            const formData = new FormData(form);
            const formValues = Object.fromEntries(formData);
         
            if (!validateOfferForm(formValues)) return;
         
            try {
                const response = await fetch('/admin/offers/category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formValues)
                });
         
                const data = await response.json();
         
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => window.location.reload());
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to create offer'
                });
            }
         }
         
         function validateOfferForm(values) {
            if (!values.discountAmount || values.discountAmount <= 0) {
                showErrorNotification('Discount amount must be greater than 0');
                return false;
            }
         
            if (values.discountType === 'percentage' && values.discountAmount > 100) {
                showErrorNotification('Percentage discount cannot exceed 100%');
                return false;
            }
         
            const startDate = new Date(values.startDate);
            const endDate = new Date(values.endDate);
            const today = new Date();
            today.setHours(0,0,0,0);
         
            if (startDate < today) {
                showErrorNotification('Start date cannot be in the past');
                return false;
            }
         
            if (endDate <= startDate) {
                showErrorNotification('End date must be after start date');
                return false;
            }
         
            return true;
         }
         
         async function deleteOffer(offerId, type) {
            try {
                const result = await Swal.fire({
                    title: 'Delete Offer?',
                    text: 'This action cannot be undone',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'Delete'
                });
         
                if (result.isConfirmed) {
                    const response = await fetch(`/admin/offers/${type}/${offerId}`, {
                        method: 'DELETE'
                    });
         
                    const data = await response.json();
         
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: data.message,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => window.location.reload());
                    } else {
                        throw new Error(data.message);
                    }
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to delete offer'
                });
            }
         }</script>
    </body>
</html>
